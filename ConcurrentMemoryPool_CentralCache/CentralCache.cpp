#include "CentralCache.hpp"

CentralCache CentralCache::_sInst;

// 获取一个非空的span
Span *CentralCache::GetOneSpan(SpanList &list, size_t size)
{
    //.........
    return nullptr;
}

// 从中心缓存获取一定数量的对象给thread cache
size_t CentralCache::FetchRangeObj(void *&start, void *&end, size_t bacthNum, size_t size)
{
    size_t index = SizeClass::Index(size); // 先根据对象的大小找到_spanLists对应的下标
    _spanLists[index]._mutex.lock();       // 寻找合适的span

    Span *span = GetOneSpan(_spanLists[index], size);
    assert(span);
    assert(span->_freeList);

    // 从span中获取batchNum个对象
    // 如果不够batchNum个，有多少拿多少
    start = span->_freeList;
    end = start;
    size_t i = 0;
    size_t actualNum = 1;
    while (i < bacthNum - 1 && NextObj(end) != nullptr)
    {
        end = NextObj(end);
        ++i;
        ++actualNum;
    }
    span->_freeList = NextObj(end);
    NextObj(end) = nullptr;

    _spanLists[index]._mutex.unlock();

    return actualNum;
}